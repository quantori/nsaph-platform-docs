<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Querying Medicaid Data &mdash; NSAPH Data Platform 0.0.2 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Gridmet Computational Utilities" href="../../gridmet/doc/index.html" />
    <link rel="prev" title="Medicare.yaml" href="members/medicare_yaml.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> NSAPH Data Platform
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../home.html">Documentation Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rationale.html">What is Data Platform</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../domains.html">Data Domains</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Health</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="LegacyMedicaid.html">Importing Medicaid Data Processed by the Legacy Pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="Medicaid.html">Handling Medicaid data</a></li>
<li class="toctree-l3"><a class="reference internal" href="Medicare.html">Medicare Files Handling</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Querying Medicaid Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#querying-diagnoses">Querying diagnoses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#overview-of-health-data-medicare-and-medicaid">Overview of health data (Medicare and Medicaid)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#project-structure">Project Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#documentation-indices">Documentation Indices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../gridmet/doc/index.html">Climate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../epa/doc/index.html">Pollution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../census/doc/index.html">Demographics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">Data Processing Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packages.html">Python Packages Included in the Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guts.html">Data Platform Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Terms and Acronyms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docindices.html">Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NSAPH Data Platform</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../domains.html">Data Domains</a> &raquo;</li>
          <li><a href="index.html">Health Data</a> &raquo;</li>
      <li>Querying Medicaid Data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/common/cms/doc/QueringMedicaid.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="querying-medicaid-data">
<h1>Querying Medicaid Data<a class="headerlink" href="#querying-medicaid-data" title="Permalink to this heading"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#querying-diagnoses" id="id1">Querying diagnoses</a></p>
<ul>
<li><p><a class="reference internal" href="#listing-patients" id="id2">Listing patients</a></p></li>
<li><p><a class="reference internal" href="#problem-no-wildcarding" id="id3">Problem: no wildcarding</a></p></li>
<li><p><a class="reference internal" href="#calculating-numbers" id="id4">Calculating numbers</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="querying-diagnoses">
<h2><a class="toc-backref" href="#id1">Querying diagnoses</a><a class="headerlink" href="#querying-diagnoses" title="Permalink to this heading"></a></h2>
<blockquote>
<div><p>Querying by diagnoses might be expensive.
Use EXPLAIN to understand and optimize your queries
See
<a class="reference internal" href="../../core-platform/doc/SampleQuery.html#using-explain-to-optimize-queries"><span class="std std-doc">SampleQuery</span></a>.</p>
</div></blockquote>
<div class="section" id="listing-patients">
<h3><a class="toc-backref" href="#id2">Listing patients</a><a class="headerlink" href="#listing-patients" title="Permalink to this heading"></a></h3>
<p>The following sample lists all patient hospitalized with specified diagnosis
codes. The code can be either primary or secondary diagnosis.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SELECT 
    state, 
    zip,
    YEAR, 
    age(admission_date::timestamp, dob::timestamp) as bene_age, 
    admission_date, 
    discharge_date, 
    diagnosis, 
    file, 
    bene_id 
FROM 
    medicaid.admissions 
        natural join medicaid.enrollments
        natural join medicaid.beneficiaries
WHERE 
    diagnosis &amp;&amp; ARRAY[&#39;29620&#39;::varchar, &#39;29633&#39;::varchar]
    AND EXTRACT (YEAR FROM age(admission_date::timestamp, dob::timestamp)) 
        BETWEEN 10 and 18
</pre></div>
</div>
<p>This query uses array operator <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>.
See <a class="reference external" href="https://www.postgresql.org/docs/13/functions-array.html">documentation</a>
to understand how it works.
It also uses two conditions in WHERE clause:</p>
<ul class="simple">
<li><p>Diagnosis has to be one of those listed (ICD9 29620 or 29633)</p></li>
<li><p>Age at a date of admission has to be between 10 and 18 years.</p></li>
</ul>
</div>
<div class="section" id="problem-no-wildcarding">
<h3><a class="toc-backref" href="#id3">Problem: no wildcarding</a><a class="headerlink" href="#problem-no-wildcarding" title="Permalink to this heading"></a></h3>
<p>Here we encounter to one of the problems.
The  syntax above (based on array operators) does not support wildcards.
You must write all the ICD codes explicitly,
something like this ‘2962*’ or ‘2962%’ will not fly.
You technically can get around this with UNNEST function,
but then the index built on<br />
diagnosis column will not be used and query performance might become horrible.</p>
<p>One solution can be to write a Python program that will generate the query
explicitly listing all required ICD codes, i.e. ‘2962’, ‘29620’,’29621’, etc.
You would need to download ICD9 data for it, e.g. from
<a class="reference external" href="https://www.nlm.nih.gov/research/umls/index.html">UMLS</a> website.</p>
</div>
<div class="section" id="calculating-numbers">
<h3><a class="toc-backref" href="#id4">Calculating numbers</a><a class="headerlink" href="#calculating-numbers" title="Permalink to this heading"></a></h3>
<p>Instead of listing patients we can just calculate the number of those patients
that are of interest to us, without seeing individual records. This is done
through aggregate queries.</p>
<p>If we want to calculate hospitalizations in every zip code for every year
separately, we can use the following query:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SELECT
    zip,
    year,
    count(*) as enrollees,
    COUNT(*) FILTER (
        WHERE bene_id IN (
            SELECT bene_id 
            FROM medicaid.admissions natural join medicaid.beneficiaries
            WHERE 
                diagnosis &amp;&amp; ARRAY[&#39;2962&#39;::varchar, &#39;2963&#39;::varchar]
                AND EXTRACT (
                    YEAR FROM age(admission_date::timestamp, dob::timestamp)
                ) BETWEEN 10 and 18
        )
    )  AS hospitalized  
FROM 
    medicaid.enrollments
    
GROUP BY
    year, 
    zip    
ORDER BY 
    year, 
    zip    
</pre></div>
</div>
<p>This query uses an
<a class="reference external" href="https://www.postgresql.org/docs/13/functions-array.html">array operator</a>
and
<a class="reference external" href="https://www.postgresql.org/docs/13/sql-expressions.html#SYNTAX-AGGREGATES">FILTER clause</a>.</p>
<p>This query calculates the number of all people enrolled in Medicaid in a certain
zip code. Instead you might want to calculate just those whos age is between 10
and 18 years. To do this you should use FILTER clause to calculate enrollees
similar to how it is used to calculate hospitalized patients.</p>
<p>Now, to calculate hospitalizations in every Zip code over all years:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SELECT
    zip,
    count(*) as enrollees,
    COUNT(*) FILTER (
        WHERE bene_id IN (
            SELECT bene_id 
            FROM medicaid.admissions natural join medicaid.beneficiaries
            WHERE 
                diagnosis &amp;&amp; ARRAY[&#39;2962&#39;::varchar, &#39;2963&#39;::varchar]
                AND EXTRACT (
                    YEAR FROM age(admission_date::timestamp, dob::timestamp)
                ) BETWEEN 10 and 18
        )
    )  AS hospitalized  
FROM 
    medicaid.enrollments
    
GROUP BY
    zip    
ORDER BY 
    3 desc, 
    zip    
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="members/medicare_yaml.html" class="btn btn-neutral float-left" title="Medicare.yaml" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../gridmet/doc/index.html" class="btn btn-neutral float-right" title="Gridmet Computational Utilities" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Harvard University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>