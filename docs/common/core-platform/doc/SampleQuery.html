<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to query the database &mdash; NSAPH Data Platform 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> NSAPH Data Platform
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../home.html">NSAPH Data Platform: Documentation Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/README.html">NSAPH Data Platform Deployment Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils/README.html">NSAPH Utils python package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">NSAPH Data Platform Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gis/README.html">NSAPH GIS python package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epa/README.html">NSAPH EPA Package Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cms/README.html">CMS Manipulation Package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NSAPH Data Platform</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>How to query the database</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/common/core-platform/doc/SampleQuery.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-query-the-database">
<h1>How to query the database<a class="headerlink" href="#how-to-query-the-database" title="Permalink to this heading"></a></h1>
<!-- toc --><!-- tocstop --><p>Here we show how to query the NSAPH database from Python.</p>
<p>We use public data (climate, pollution, census) in the query,
hence it can be executed in any environment.</p>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this heading"></a></h2>
<section id="create-python-virtual-environment">
<h3>Create Python Virtual Environment<a class="headerlink" href="#create-python-virtual-environment" title="Permalink to this heading"></a></h3>
<p>First, we need to create a Python virtual environment. This can
be done with commands like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="o">.</span><span class="n">nsaph</span>
<span class="n">source</span> <span class="o">.</span><span class="n">nsaph</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
</pre></div>
</div>
</section>
<section id="install-nsaph-packages">
<h3>Install NSAPH packages<a class="headerlink" href="#install-nsaph-packages" title="Permalink to this heading"></a></h3>
<p>Next, we need to install NSAPH core packages. This can be done
using GitHub install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NSAPH</span><span class="o">-</span><span class="n">Data</span><span class="o">-</span><span class="n">Platform</span><span class="o">/</span><span class="n">nsaph</span><span class="o">-</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NSAPH</span><span class="o">-</span><span class="n">Data</span><span class="o">-</span><span class="n">Platform</span><span class="o">/</span><span class="n">nsaph</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">platform</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</section>
</section>
<section id="create-connection-definition-file">
<h2>Create connection definition file<a class="headerlink" href="#create-connection-definition-file" title="Permalink to this heading"></a></h2>
<p>We need to create or update a database.ini file that stores connections
to the database. Here is a sample file I use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mimic</span><span class="p">]</span>
<span class="n">host</span><span class="o">=</span><span class="n">localhost</span>
<span class="n">database</span><span class="o">=</span><span class="n">mimicii</span>
<span class="n">user</span><span class="o">=</span><span class="n">postgres</span>
<span class="n">password</span><span class="o">=*****</span>

<span class="p">[</span><span class="n">nsaph2</span><span class="p">]</span>
<span class="n">host</span><span class="o">=</span><span class="n">nsaph</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">fas</span><span class="o">.</span><span class="n">harvard</span><span class="o">.</span><span class="n">edu</span>
<span class="n">database</span><span class="o">=</span><span class="n">nsaph2</span>
<span class="n">user</span><span class="o">=</span><span class="n">mbouzinier</span>
<span class="n">password</span><span class="o">=*********</span>
<span class="n">ssh_user</span><span class="o">=</span><span class="n">mbouzinier</span>
</pre></div>
</div>
<blockquote>
<div><p>Note that the first connection uses my local instance of PostgreSQL
on my laptop. The second connects to NSAPH database. It is using ssh
tunnel to connect - this is defined by adding ssh_user parameter.</p>
<p><strong><em>mbouzinier</em></strong> is my username for both ssh and the database.</p>
</div></blockquote>
</section>
<section id="executing-the-query">
<h2>Executing the query<a class="headerlink" href="#executing-the-query" title="Permalink to this heading"></a></h2>
<p>We will use the following sample Python program to execute
a query (with public data) on the NSAPH database:
<a class="reference external" href="members/query.html">query.py</a></p>
<p>Copy the file into your local directory and execute it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">query</span><span class="o">.</span><span class="n">py</span> <span class="n">database</span><span class="o">.</span><span class="n">ini</span> <span class="n">nsaph2</span>
</pre></div>
</div>
</section>
<section id="using-explain-to-optimize-queries">
<h2>Using EXPLAIN to optimize queries<a class="headerlink" href="#using-explain-to-optimize-queries" title="Permalink to this heading"></a></h2>
<p>You do not want to run a query that will take a week to execute. When we have
hundreds of millions of records, this can easily happen. SQL is a declarative
language, hence, an SQL statement describes what you want to do. DBMS optimizer
decides how to do it. It should understand your query correctly. To ensure, it
did, use EXPLAIN query before trying to execute. See documentation for EXPLAIN.</p>
<p>Here are a few more links that might be useful:</p>
<ul class="simple">
<li><p>How to read <a class="reference external" href="https://thoughtbot.com/blog/reading-an-explain-analyze-query-plan">query plans</a>
produced by EXPLAIN</p></li>
<li><p><a class="reference external" href="https://scalegrid.io/blog/postgres-explain-cost/">What is cost</a></p></li>
</ul>
<p>Unfortunately, less useful is the
<a class="reference external" href="https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-explain/">tutorial</a>
The queries below (given as examples) take 4 to 8 minutes each. I suggest
running them with EXPLAIN first, note the costs and compare them with any costs
of the queries you will write. Pay attention how indices are used: the most
expensive part is scan.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Harvard University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>