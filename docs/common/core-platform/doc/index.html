<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NSAPH Core Data Platform &mdash; NSAPH Data Platform 0.0.2 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Data Modelling for NSAPH Data Platform" href="Datamodels.html" />
    <link rel="prev" title="NSAPH Utils python package" href="../../utils/doc/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> NSAPH Data Platform
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../home.html">Documentation Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rationale.html">What is Data Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../domains.html">Data Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">Data Processing Pipelines</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../packages.html">Python Packages Included in the Platform</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../utils/doc/index.html">General purpose utilities</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Data platform components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Datamodels.html">Data Modelling for NSAPH Data Platform</a></li>
<li class="toctree-l3"><a class="reference internal" href="DataLoader.html">NSAPH Data Loader</a></li>
<li class="toctree-l3"><a class="reference internal" href="ProjectLoader.html">Project (Directory) Loading Utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="TerritorialCodes.html">Mapping between different territorial codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="SampleQuery.html">How to query the database</a></li>
<li class="toctree-l3"><a class="reference internal" href="UserRequests.html">Preliminary Considerations for Handling User Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="SQLDocumentation.html">SQL Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tool-examples">Tool Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#project-structure">Project Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#software-sources">Software Sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-packages">Python packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#yaml-files">YAML files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resources">Resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sql-utilities">SQL Utilities</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#documentation-indices">Documentation Indices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../gis/doc/index.html">GIS utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gridmet/doc/index.html">gridMET tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../epa/doc/index.html">EPA tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cms/doc/CMSLibrary.html">Health data manipulation tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../census/doc/index.html">Census data manipulation tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guts.html">Data Platform Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Terms and Acronyms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docindices.html">Indices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NSAPH Data Platform</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../packages.html">Python Packages Included in the Platform</a> &raquo;</li>
      <li>NSAPH Core Data Platform</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/common/core-platform/doc/index.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="nsaph-core-data-platform">
<h1>NSAPH Core Data Platform<a class="headerlink" href="#nsaph-core-data-platform" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="https://nsaph-data-platform.github.io/nsaph-platform-docs/home.html">Documentation Home</a></p>
<div class="toctree-wrapper compound">
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#tool-examples" id="id1">Tool Examples</a></p></li>
<li><p><a class="reference internal" href="#project-structure" id="id2">Project Structure</a></p>
<ul>
<li><p><a class="reference internal" href="#software-sources" id="id3">Software Sources</a></p></li>
<li><p><a class="reference internal" href="#python-packages" id="id4">Python packages</a></p>
<ul>
<li><p><a class="reference internal" href="#nsaph-package" id="id5">NSAPH Package</a></p>
<ul>
<li><p><a class="reference internal" href="#subpackage-for-data-modelling" id="id6">Subpackage for Data Modelling</a></p></li>
<li><p><a class="reference internal" href="#module-database-connection-wrapper" id="id7">Module Database Connection Wrapper</a></p></li>
<li><p><a class="reference internal" href="#loader-subpackage" id="id8">Loader Subpackage</a></p></li>
<li><p><a class="reference internal" href="#subpackage-to-describe-and-implement-user-requests-incomplete" id="id9">Subpackage to describe and implement user requests [Incomplete]</a></p></li>
<li><p><a class="reference internal" href="#subpackage-with-miscellaneous-utilities" id="id10">Subpackage with miscellaneous utilities</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#yaml-files" id="id11">YAML files</a></p></li>
<li><p><a class="reference internal" href="#resources" id="id12">Resources</a></p></li>
<li><p><a class="reference internal" href="#sql-utilities" id="id13">SQL Utilities</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#documentation-indices" id="id14">Documentation Indices</a></p></li>
</ul>
</div>
<div class="section" id="tool-examples">
<h2><a class="toc-backref" href="#id1">Tool Examples</a><a class="headerlink" href="#tool-examples" title="Permalink to this heading"></a></h2>
<p>Examples of tools included in this package are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="members/data_loader.html"><span class="doc std std-doc">Universal Data Loader</span></a></p></li>
<li><p>A <a class="reference internal" href="members/index.html"><span class="doc std std-doc">utility to monitor progress of long-running database</span></a> processes like indexing.</p></li>
<li><p>A <a class="reference internal" href="members/analyze.html"><span class="doc std std-doc">utility to infer database schema and generate DDL</span></a> from a CSV file</p></li>
<li><p>A <a class="reference internal" href="members/link_gis.html"><span class="doc std std-doc">utility to link a table to GIS</span></a> from a CSV file</p></li>
<li><p>A <a class="reference internal" href="#module-database-connection-wrapper"><span class="std std-doc">wrapper around database connection to PostgreSQL</span></a></p></li>
<li><p>A <a class="reference internal" href="members/pg_json_dump.html"><span class="doc std std-doc">utility to import/export JSONLines</span></a> files into/from PostgreSQL</p></li>
<li><p>An <a class="reference internal" href="members/executors.html"><span class="doc std std-doc">Executor with a bounded queue</span></a></p></li>
</ul>
</div>
<div class="section" id="project-structure">
<span id="core-prj-struct"></span><h2><a class="toc-backref" href="#id2">Project Structure</a><a class="headerlink" href="#project-structure" title="Permalink to this heading"></a></h2>
<p><strong>The package is under intensive development, the project structure is in flux</strong></p>
<p>Top level directories are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- doc
- resources
- src
</pre></div>
</div>
<p>Doc directory contains documentation.</p>
<p>Resource directory contains resources that must be loaded in
the data platform for its normal functioning. For example,
they contain mappings between US states, counties, fips and zip codes.
See details in <a class="reference internal" href="#resources"><span class="std std-doc">Resources</span></a> section.</p>
<p>Src directory contains software source code.
See details in <a class="reference internal" href="#core-software-sources"><span class="std std-ref">Software Sources</span></a> section.</p>
<div class="section" id="software-sources">
<span id="core-software-sources"></span><h3><a class="toc-backref" href="#id3">Software Sources</a><a class="headerlink" href="#software-sources" title="Permalink to this heading"></a></h3>
<p>The directories under sources are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- airflow
- commonwl
- html
- plpgsql
- python
- r
- superset
- yml
</pre></div>
</div>
<p>They are described in more details in the corresponding sections.
Here is a brief overview:</p>
<ul class="simple">
<li><p><strong>airflow</strong> contains code and configuration for Airflow.
Most of the content is deprecated as it is now transferred
to the deployment package or the specific pipelines. However,
this directory is intended to contain Airflow plugins that are
generic for all NSAPH pipelines</p></li>
<li><p><strong>commonwl</strong> contains reusable workflows, packaged as tools
that can and should be used by
all NSAPH pipelines. Examples of such tools
are: introspection of CSV files, indexing tables, linking
tables with GIS information for easy mapping, creation of a
Superset datasource.</p></li>
<li><p><strong>html</strong> is a deprecated directory for HTML documents</p></li>
<li><p><strong>plpgsql</strong> contains PostgreSQL procedures and functions
implemented in PL/pgSQL language</p></li>
<li><p><strong>python</strong> contains Python code. See <a class="reference internal" href="#python-packages"><span class="std std-doc">more details</span></a>.</p></li>
<li><p><strong>r</strong> contains R utilities. Probably will be deprecated</p></li>
<li><p><strong>superset</strong> contains definitions of reusable Superset datasets and dashboards</p></li>
<li><p><strong>yml</strong> contains various YAML files used by the platform.</p></li>
</ul>
</div>
<div class="section" id="python-packages">
<h3><a class="toc-backref" href="#id4">Python packages</a><a class="headerlink" href="#python-packages" title="Permalink to this heading"></a></h3>
<div class="section" id="nsaph-package">
<h4><a class="toc-backref" href="#id5">NSAPH Package</a><a class="headerlink" href="#nsaph-package" title="Permalink to this heading"></a></h4>
<p>This is the main package containing the majority of the code.
Modules and subpackages included in <code class="docutils literal notranslate"><span class="pre">nsaph</span></code> package are described below.</p>
<div class="section" id="subpackage-for-data-modelling">
<h5><a class="toc-backref" href="#id6">Subpackage for Data Modelling</a><a class="headerlink" href="#subpackage-for-data-modelling" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nsaph.data_model</span></code></p></li>
</ul>
<p>Implements version 2 of the data modelling toolkit.</p>
<p>Version 1 was focused on loading into the database already
processed data saved as flat files. It inferred data
model from the data files structure and accompanied README
files. The inferred data model is converted to database schema
by generating appropriate DDL.</p>
<p>Version 2 focuses on generating code required to do the
actual processing. The main concept is a knowledge domain, or
just a domain. Domain model is define in a YAML file as
described in the <a class="reference internal" href="Datamodels.html"><span class="doc std std-doc">documentation</span></a>. The main
module that processes the YAML definition of the domain
is <a class="reference internal" href="members/domain.html"><span class="doc std std-doc">domain.py</span></a>. Another
module, <a class="reference internal" href="members/inserter.html"><span class="doc std std-doc">inserter</span></a>
handles parallel insertion of the data into domain tables.</p>
<p>Auxiliary modules perform various maintenance tasks.
Module <a class="reference internal" href="members/index_builder.html"><span class="doc std std-doc">index_builder</span></a>
builds indices for a given tables or for all
tables within a domain.
Module <a class="reference internal" href="members/utils.html"><span class="doc std std-doc">utils</span></a>
provides convenience function wrappers and defines
class DataReader that abstracts reading CSV and FST files.
In other words, DataReader provides uniform interface
to reading columnar files in two (potentially more)
different formats.</p>
</div>
<div class="section" id="module-database-connection-wrapper">
<h5><a class="toc-backref" href="#id7">Module Database Connection Wrapper</a><a class="headerlink" href="#module-database-connection-wrapper" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nsaph.db</span></code></p></li>
</ul>
<p>Module <a class="reference internal" href="members/db.html"><span class="doc std std-doc">db</span></a> is a PostgreSQL
connection wrapper. It reads connection parameters from
an <code class="docutils literal notranslate"><span class="pre">ini</span></code> file and connects to the database. It can
transparently connect over <strong>ssh tunnel</strong> when required.</p>
</div>
<div class="section" id="loader-subpackage">
<h5><a class="toc-backref" href="#id8">Loader Subpackage</a><a class="headerlink" href="#loader-subpackage" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nsaph.loader</span></code></p></li>
</ul>
<p>A set of utilities to manipulate data.</p>
<p>Module <a class="reference internal" href="members/data_loader.html"><span class="doc std std-doc">data_loader</span></a>
Implements parallel loading data into a PostgreSQL database.
It is also responsible for loading DDL and creation of view,
both virtual and materialized.</p>
<p>Module <a class="reference internal" href="members/index_builder.html"><span class="doc std std-doc">index_builder</span></a>
is a utility to build indices and monitor the build progress.</p>
</div>
<div class="section" id="subpackage-to-describe-and-implement-user-requests-incomplete">
<h5><a class="toc-backref" href="#id9">Subpackage to describe and implement user requests [Incomplete]</a><a class="headerlink" href="#subpackage-to-describe-and-implement-user-requests-incomplete" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nsaph.requests</span></code></p></li>
</ul>
<p>Package <code class="docutils literal notranslate"><span class="pre">nsaph.requests</span></code> contains some code that is
intended to be used for fulfilling user requests. Its
development is currently put on hold.</p>
<p>Module <a class="reference internal" href="members/hdf5_export.html"><span class="doc std std-doc">hdf5_export</span></a> exports
result of SQL query as an HDF5 file. The structure of the HDF5 is
described by a YAML request definition.</p>
<p>Module <a class="reference internal" href="members/query.html"><span class="doc std std-doc">query</span></a> generates SQL query
from a YAML request definition.</p>
</div>
<div class="section" id="subpackage-with-miscellaneous-utilities">
<h5><a class="toc-backref" href="#id10">Subpackage with miscellaneous utilities</a><a class="headerlink" href="#subpackage-with-miscellaneous-utilities" title="Permalink to this heading"></a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nsaph.util</span></code></p></li>
</ul>
<p>Package <code class="docutils literal notranslate"><span class="pre">nsaph.util</span></code> contains:</p>
<ul class="simple">
<li><p>Support for packaging <a class="reference internal" href="#resources"><span class="std std-doc">resources</span></a>
in two modules <a class="reference internal" href="members/resources.html"><span class="doc std std-doc">resources</span></a>
and <a class="reference internal" href="members/pg_json_dump.html"><span class="doc std std-doc">pg_json_dump</span></a>. The
latter module imports and exports PostgreSQL (pg) tables
as JSONLines format.</p></li>
<li><p>Module <a class="reference internal" href="members/net.html"><span class="doc std std-doc">net</span></a> contains
one method resolving host to <code class="docutils literal notranslate"><span class="pre">localhost</span></code>. This method is
required by Airflow.</p></li>
<li><p>Module <a class="reference internal" href="members/executors.html"><span class="doc std std-doc">executors</span></a>
implements a
<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor">ThreadPoolExecutor</a>
with a bounded queue. It is used to prevent out of memory (OOM)
errors when processing huge files (to prevent loading
the whole file into memory before dispatching it for processing).</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="yaml-files">
<h3><a class="toc-backref" href="#id11">YAML files</a><a class="headerlink" href="#yaml-files" title="Permalink to this heading"></a></h3>
<p>The majority of files are data model definitions. For now, they
are included in <strong>nsaph</strong> package because they are used by
different utilities and thus, expected to be stored in
a specific location.</p>
<p>Beside data model files, there are YAML files for:</p>
<ul class="simple">
<li><p>Conda environments, required for NSAPH pipelines. Unless we
will be able to create a single environment that accomodate
all pipelines we will probably deprecate them and move
into corresponding pipeline repositories.</p></li>
<li><p>Sample user requests for future downstream pipelines
that create user workspaces from the database. File
<a class="reference internal" href="members/example_request.yaml.html"><span class="doc std std-doc">example_request.yml</span></a> is used by
<a class="reference internal" href="members/hdf5_export.html"><span class="doc std std-doc">sample request handler</span></a></p></li>
</ul>
</div>
<div class="section" id="resources">
<h3><a class="toc-backref" href="#id12">Resources</a><a class="headerlink" href="#resources" title="Permalink to this heading"></a></h3>
<p>Resources are organized in the following way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- ${database schema}/
    - ddl file for ${resource1}
    - content of ${resource1} in JSON Lines format (*.json.gz)
    - ddl file for ${resource2}
    - content of ${resource2} in JSON Lines format (*.json.gz)
</pre></div>
</div>
<p>Resources can be packaged when a
<a class="reference external" href="https://pythonwheels.com/">wheel</a>
is built. Support for packaging resources during development and
after a package is deployed is provided by
<a class="reference internal" href="members/resources.html"><span class="doc std std-doc">resources</span></a> module.</p>
<p>Another module, <a class="reference internal" href="members/pg_json_dump.html"><span class="doc std std-doc">pg_json_dump</span></a>,
provides support for packaging tables as resources in JSONLines
format. This format is used natively by some DBMSs.</p>
</div>
<div class="section" id="sql-utilities">
<h3><a class="toc-backref" href="#id13">SQL Utilities</a><a class="headerlink" href="#sql-utilities" title="Permalink to this heading"></a></h3>
<p>Utilities, implementing the following:</p>
<ul class="simple">
<li><p><a class="reference internal" href="members/utils.sql.html"><span class="doc std std-doc">Functions</span></a>:</p>
<ul>
<li><p>Counting rows in tables</p></li>
<li><p>Finding a name of the column that contains year from most tables used in data platform</p></li>
<li><p>Creating a hash for <a class="reference external" href="https://en.wikipedia.org/wiki/HyperLogLog">HLL aggregations</a></p></li>
</ul>
</li>
<li><p>Procedure:</p>
<ul>
<li><p><a class="reference internal" href="members/utils.sql.html"><span class="doc std std-doc">A procedure</span></a> granting <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> privileges
to a user on all NSAPH tables</p></li>
<li><p><a class="reference internal" href="members/rename_indices.sql.html"><span class="doc std std-doc">A procedure to rename indices</span></a></p></li>
</ul>
</li>
<li><p>Set of SQL statements:
<a class="reference internal" href="members/map_to_foreign_database.ddl.html"><span class="doc std std-doc">to map tables from another database</span></a>
This can be used to map public tables available to anybody
to a more secure database, containing health data</p></li>
</ul>
<p>Utilities used to map territorial codes are described in
<a class="reference internal" href="TerritorialCodes.html"><span class="doc std std-doc">this document</span></a></p>
</div>
</div>
<div class="section" id="documentation-indices">
<span id="core-soft-idx"></span><h2><a class="toc-backref" href="#id14">Documentation Indices</a><a class="headerlink" href="#documentation-indices" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../../../genindex.html"><span class="std std-ref">genindex</span></a></p></li>
<li><p><a class="reference internal" href="../../../py-modindex.html"><span class="std std-ref">modindex</span></a></p></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../utils/doc/index.html" class="btn btn-neutral float-left" title="NSAPH Utils python package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Datamodels.html" class="btn btn-neutral float-right" title="Data Modelling for NSAPH Data Platform" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Harvard University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>